{% set name = "diffoscope" %}
{% set version = "154" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  url: https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/{{ name }}-{{ version }}.tar.gz
  sha256: d8ab3453c3ee25059cd0528a46bf6bced417fa49acac3ba3a0bfba7f48968b21

build:
  number: 0
  noarch: python
  script: {{ PYTHON }} -m pip install . --no-deps -vv
  entry_points:
    - diffoscope = diffoscope.main:main

requirements:
  build:
    - python >=3.5
    - pip
  run:
    - python >=3.5
    - python-libarchive-c
    - python-magic
    - python-tlsh

{% set test_skips = [
  "assert_non_existing",
  "test_berkeley_db",
  "test_code_is_black_clean",
  "test_icc",
  "test_wasm",
] %}

test:
  source_files:
    - tests
  requires:
    # pip check
    - pip
    # real test deps
    - file
    - pytest
    # test extras
    - pytest-azurepipelines
    - pytest-cov
    # extra tools
    - argcomplete
    - binutils
    - bzip2
    - defusedxml
    - ffmpeg
    - gettext
    - ghc
    - giflib
    - hdf5
    - imagemagick
    - jsondiff
    - libdb
    - mono
    - ocaml
    - openssh
    - postgresql
    - progressbar
    - pypdf2
    - python-debian
    - rpm-tools
    - vim
    - wabt
  imports:
    - diffoscope
  commands:
    - python -m pip check
    - diffoscope --version | grep {{ version }}
    - diffoscope --help
    - diffoscope --list-tools
    - diffoscope --list-missing-tools
    - cp {{ RECIPE_DIR }}/setup.cfg .
    # rest of test options in setup.cfg
    - pytest -k "not ({{ ' or '.join(test_skips) }})"

about:
  home: https://diffoscope.org
  license: GPL-3.0-or-later
  summary: in-depth comparison of files, archives, and directories
  license_family: GPL
  license_file: COPYING
  dev_url: https://anonscm.debian.org/cgit/reproducible/diffoscope.git
  description: |-
    diffoscope will try to get to the bottom of what makes files or directories
    different. It will recursively unpack archives of many kinds and transform
    various binary formats into more human readable form to compare them. It can
    compare two tarballs, ISO images, or PDF just as easily.

extra:
  recipe-maintainers:
    - bollwyvl
